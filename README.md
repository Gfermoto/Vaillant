# Vaillant eloBLOCK & atmoTEC (ebusd)

**Для взаимодействия с котлом требуются некоторые приготовления:**

---

### 1. Преобразователь для соединения с котлом
Для обмена данными через EBUS необходим преобразователь. Рекомендуемый вариант:  
[EBUSD Adapter v5-c6](https://adapter.ebusd.eu/v5-c6/index.en.html)  

Также рекомендуется приобрести преобразователь **USR-ES1**, чтобы снизить задержки и джиттер, что улучшит стабильность синхронизации и аудита.

---

### 2. Установка демона EBUSD
Демон EBUSD можно запустить в контейнере Docker или как дополнение в HASSio.  
- Репозиторий EBUSD: [john30/ebusd](https://github.com/john30/ebusd)  
- Пример `docker-compose.yml`: [docker-compose файл](https://github.com/Gfermoto/Vaillant/blob/main/docker-compose.yml)  
- Репозиторий для HASSio: [LukasGrebe/ha-addons](https://github.com/LukasGrebe/ha-addons)  
- Пример файла настроек: [ebusd.txt](https://github.com/Gfermoto/Vaillant/blob/main/ebusd.txt)  

Для работы с кастомными файлами настроек необходимо сделать локальную копию конфигурационных файлов и указать пути к ним.  
Репозиторий конфигураций: [john30/ebusd-configuration](https://github.com/john30/ebusd-configuration)

---

### 3. Сервер MQTT
Сервер MQTT можно поднять в контейнере Docker или как дополнение в HASSio.  
Вероятно, он у вас уже настроен.

---

### 4. MQTT-Discovery
Дальнейшую работу выполнит MQTT-Discovery.

---

## Изменения в конфигурационных файлах

### Файл `mqtt-hassio.cfg`
1. **Закомментирован фильтр сообщений:**  
   ```plaintext
   (filter-name)
   ```
2. **Добавлено отслеживание записываемых сообщений:**  
   ```plaintext
   (filter-direction = r|u|^w)
   ```  
   *(Это позволяет получать больше информации)*  

---

### Файл `08.bai.csv`
Добавлены строки для котлов Vaillant:
- Для **eloBLOCK** SW0109, HW7503 (0010023658):  
  ```plaintext
  [PROD='0010023658']!load,bai.0010023658.inc,,,
  ```  
- Для **atmoTEC** SW0407, HW0903 (0010015251):  
  ```plaintext
  [PROD='0010015251']!load,bai.0010015251.inc,,,
  ```  

---

### Файл `bai.0010023658.inc`
Создан путем слияния файлов `bai.0010008045.inc` и `bai.308523.inc`.  
- Закомментированы строки `## d.xx`, относящиеся к функциям, недоступным в Vaillant eloBLOCK.  
- Добавлены закомментированные строки `# d.xx`, относящиеся к функциям, присутствующим в руководстве, но неизвестным.  
- Некоторые функции заимствованы из других файлов.  

Полученное описание требует проверки, корректировки и дополнения.  
Нерешенные проблемы: [ebusd_eloBLOCK.log](https://github.com/Gfermoto/Vaillant/blob/main/ebusd_eloBLOCK.log)  
**(Буду признателен за помощь)**

---

### Файл `bai.0010015251.inc`
Создан путем слияния файлов `bai.0010004121.inc` и `bai.308523.inc`.  
- Закомментированы строки `## d.xx`, относящиеся к функциям, недоступным в Vaillant atmoTEC.  
- Добавлены закомментированные строки `# d.xx`, относящиеся к функциям, присутствующим в руководстве, но неизвестным.  
- Некоторые функции заимствованы из других файлов.  

Полученное описание требует проверки, корректировки и дополнения.  
Нерешенные проблемы: [ebusd_atmoTEC.log](https://github.com/Gfermoto/Vaillant/blob/main/ebusd_atmoTEC.log)  
**(Буду признателен за помощь)**

---

### Конфигурационный файл `bai.308523.inc`
Этот файл используется по умолчанию, если котел не распознан *(содержит общие сообщения, но не все)*.  
Второй конфигурационный файл выбирался на основе схожести аппаратных версий плат управления **(HW)**.  
Закомментированные не поддерживаемые функции `d.xx` сопряжены с версией программного обеспечения платы **(SW)**.

---

## Особенности работы с электрическими котлами (eloBLOCK)
Котел имеет сухой контакт для ограничения мощности, если это настроено. Необходимо настроить ограничение по всем фазам или на какой-то конкретной, а также уровень ограничения. Это число будет вычитаться из максимального настроенного уровня.  

Однако при настройке ограничения по всем фазам для котла с максимальной мощностью 18 кВт можно настроить ограничение только кратное 6, то есть 6 кВт, 12 кВт и 18 кВт.  

**Пример:**  
- Настроенная мощность: 10 кВт.  
- Ограничение мощности: 6 кВт.  
- При размыкании контакта мощность будет выставлена на 4 кВт (10 кВт - 6 кВт).  

Для размыкания контакта удобно использовать реле **ESPHome**:  
- Устройство: [ESP-01S 1-channel relay](https://devices.esphome.io/devices/ESP-01S-1-channel-relay)  
- Корпус: [Thingiverse](https://www.thingiverse.com/thing:4196595)  
- Пример настроек: [vaillant_power.yaml](https://github.com/Gfermoto/Vaillant/blob/main/vaillant_power.yaml)  

Если у вас есть HASSio и датчик потребляемой энергии, можно настроить автоматизацию, которая временно снизит лимит потребления энергии котлом при превышении нагрузки в сети. Это полезно при включении мощных потребителей, таких как стиральная машина или духовка.  
Рекомендую автоматизацию: https://community.home-assistant.io/t/appliance-notifications-actions-washing-machine-clothes-dryer-dish-washer-etc/650166

---

## Управление отоплением

### Термостаты и актуаторы
Любой котел имеет сухой контакт для подключения нецифрового термостата. Рекомендуется использовать контроллер теплых полов **Beok CCT-10** для зонального отопления. Это устройство управляет рециркуляционным насосом и котлом по схеме "ИЛИ", что экономично, так как насос отключается при отсутствии запроса тепла.  

Для интеграции термостатов в HASSio рекомендуется проект:  
[WThermostatBeca](https://github.com/fashberg/WThermostatBeca)  

Для управления актуаторами рекомендуется использовать контроллеры и актуаторы с нормально открытым (NO) состоянием.

---

### Автоматизация отопления
Пример автоматизации для управления отоплением:  
[Advanced Heating Control](https://github.com/panhans/HomeAssistant/blob/main/blueprints/automation/panhans/advanced_heating_control.yaml)  

Отопление активируется в ночные часы по дешевому тарифу, а также при наличии людей в доме.  

- **Радиаторы**: Настроены на разные температуры для разных помещений.  
- **Теплые полы**: Включаются на одинаковую температуру в соответствии с автоматизацией.  

Важно, чтобы запрос тепла от полов отключался раньше радиаторов, так как у котла нет **bypass**. Хотя бы один радиатор должен быть открыт, пока работает котел. Этого можно добиться программной калибровкой термостатических головок и правильным расположением термостатов.

---

## Каскадное соединение котлов
При каскадном соединении котлов сухие контакты нельзя соединять параллельно. Также у меня не получилось запустить котлы на одной шине EBUS, поэтому я использовал два преобразователя и два демона ebusd в разных контейнерах.

---

Если у вас есть вопросы или предложения, пожалуйста, создайте issue или свяжитесь со мной.  
**Спасибо за внимание!**
